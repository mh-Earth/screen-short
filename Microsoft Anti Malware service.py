import socket
import cv2
import numpy as np
from PIL import ImageGrab


HOST = socket.gethostbyname(socket.gethostname())
PORT = 8888  # server port number

def send_screenshot(conn):
    # Take a screenshot using PIL ImageGrab
    screenshot = ImageGrab.grab()
    # Convert PIL Image to OpenCV image
    screenshot = np.array(screenshot)
    screenshot = cv2.cvtColor(screenshot, cv2.COLOR_RGB2BGR)
    # Encode OpenCV image to JPEG format
    _, img_encoded = cv2.imencode('.jpg', screenshot)
    # Send image size to client
    conn.sendall(str(len(img_encoded)).encode().ljust(16))
    # Send image data to client
    conn.sendall(img_encoded)

with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
    s.bind((HOST, PORT))
    s.listen()
    print('Server listening on {}:{}'.format(HOST, PORT))
    while True:
        # Wait for client connection
        conn, addr = s.accept()
        # print('Connected by', addr)
        # Send screenshot to client
        send_screenshot(conn)
        
